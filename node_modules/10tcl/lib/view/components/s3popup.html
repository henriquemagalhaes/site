{{#s3popup}}
<div id='{{popupId}}' class='modal hide fade'>
	<div class='modal-header'>
		<button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>
		<h3>{{popupLabel}}</h3>
	</div>
	<div class='modal-body'>
		
		{{#credentials}}
		<form id='{{popupId}}-form' class='s3-file-form form-horizontal' method='POST' enctype='multipart/form-data' action='{{bucketURL}}'>
			<input type='hidden' name='AWSAccessKeyId' value='{{awsKey}}' />
			<input type='hidden' name='acl' value='{{accessType}}' />
			<input type='hidden' name='policy' value='{{encodedPolicy}}' />
			<input type='hidden' name='signature' value='{{encodedSignature}}' />
			<input type='hidden' name='Content-Type' />
			<input type='hidden' name='key' />

			<div class="control-group">
			    <label class="control-label" for="inputEmail">Arquivo:</label>
			    <div class="controls">
			    	<input type='file' name='file' accept='image/*' />
			    </div>
			</div>
		</form>
		{{/credentials}}

	</div>
	<div class='modal-footer'>
		<a href='#' class='close btn'>Fechar</a>
	</div>
</div>

<script type='text/javascript'>
	$(document).ready(function(){
		$('#{{popupId}} input[name=file]').change(function(eventObject){

			function guid() {
				var S4 = function() { return (((1+Math.random())*0x10000)|0).toString(16).substring(1) }
				return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()
			}

			var file = this.files[0]
			  , fileExt = file.type.split('/')[1]
			  , fileName = guid() + '.' + fileExt 

			$('#{{popupId}} input[name=key]').val('images/'+fileName)
			$('#{{popupId}} input[name=Content-Type]').val(file.type)
			
			var form = document.getElementById('{{popupId}}-form')
			  , formData = new FormData(form)
			  , bucketURL = $('#{{popupId}}-form').attr('action')
			
			$.ajax({
				type: 'POST',
				url: bucketURL,
				data: formData,
				cache: false,
				context: { fileName: fileName },
				contentType: false,
				processData: false,
				success: {{popupId}}Callback
			})
		})
	})
</script>

{{/s3popup}}