<div id='<%= field.name %>-tag-selector' class='tag-selector dropdown-wrapper'>
	<div class='selected-tags' name='<%= field.name %>' data-fieldset='<%= fieldset.name %>'></div>
	<button class='btn dropdown' data-toggle='dropdown'>Adicionar</button>
	<ul id='<%= field.name %>-categories' class='tags-menu dropdown-menu'></ul>
</div>

<script id='<%= field.name %>-tag-tpl' type='text/html'>
	<span class='tag label label-primary'>
		{{.}}
		<a href='#' onClick='$.view.<%= field.name %>RemoveTag( "{{.}}" )'>
			<i class='glyphicon glyphicon-remove'></i>
		</a>
	</span>
</script>

<script id='<%= field.name %>-menu-tpl' type='text/html'>
	<li class='dropdown-submenu'>
		<a tabindex='-1' href='#'>{{categoryName}}</a>
		<ul class='dropdown-menu'>
		{{#tags}}
			<li><a tabindex='-1' href='#' onClick='$.view.<%= field.name %>AddTag( "{{tagName}}" )'>{{tagName}}</a></li>
		{{/tags}}
		</ul>
	</li>
</script>

<script type='text/javascript'>
	
	<% if ( field.of.isArray() ) { %>

		<% field.of.forEach( function( model ){ %>

			$.model.talkToServer( 'GET', '<%= baseURL %>/<%= model %>/tags', function( records, txt, jqXHR ){ 
				var menuTpl = $('#<%= field.name %>-menu-tpl').html()
				$('#<%= field.name %>-categories').append( Mustache.render( menuTpl, records ) )
			})

		<% }) %>

	<% } else { %>

		$.model.talkToServer( 'GET', '<%= baseURL %>/<%= field.of %>/tags', function( records, txt, jqXHR ){ 
			var menuTpl = $('#<%= field.name %>-menu-tpl').html()
			$('#<%= field.name %>-categories').append( Mustache.render( menuTpl, records ) )
		})

	<% } %>


	$.view.<%= field.name %>AddTag = function( tag ){
		if ( !$.model.record.<%= field.name %> ) $.model.record.<%= field.name %> = []
		if ( $.model.record.<%= field.name %>.none( tag ) ){
			$.model.record.<%= field.name %>.push( tag )
			$.model.record.<%= field.name %>.sort()	
		} 

		$.view.<%= field.name %>RenderTags()
	}

	$.view.<%= field.name %>RemoveTag = function( tag ){
		tags = $.model.record.<%= field.name %>
		if ( tags.some( tag ) ) tags.remove( tag )

		$.view.<%= field.name %>RenderTags()	
	}

	$.view.<%= field.name %>RenderTags = function(){
		tags = $.model.record.<%= field.name %> ? $.model.record.<%= field.name %> : []

		$('.selected-tags[name=<%= field.name %>]').html('')

		tags.forEach( function( tag ){
			var tagTpl = $('#<%= field.name %>-tag-tpl').html()
			$('.selected-tags[name=<%= field.name %>]').append( Mustache.render( tagTpl, tag ))
		})
	}

</script>