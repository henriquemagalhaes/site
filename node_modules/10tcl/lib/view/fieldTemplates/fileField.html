<div class="input-group">
	<input class='form-control' type='text' readonly='true' name='<%= field.name %>' data-fieldset='<%= fieldset.name %>' />
	<span class="input-group-btn">
		<a id="<%= field.name %>-upload-btn" class="btn btn-default clicable" data-toggle="modal" data-target="#<%= field.name %>-s3popup">
			<i class="glyphicon glyphicon-upload"></i>
		</a>
	</span>
</div>

<script id='<%= field.name %>-s3popup-html' type='text/html'>
	
	<div class="modal fade" id='<%= field.name %>-s3popup'>
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
					<h4 class="modal-title"><%= field.label %></h4>
				</div>
				<div class="modal-body">

					<form id="<%= field.name %>-s3popup-form" class="s3-file-form form-horizontal" method="POST" enctype="multipart/form-data" action="<%= s3credentials.bucketURL %>" data-fileURL="<%= s3credentials.fileURL %>">
						<input type='hidden' name='AWSAccessKeyId' value='<%= s3credentials.awsKey %>' />
						<input type='hidden' name='acl' value='<%= s3credentials.accessType %>' />
						<input type='hidden' name='policy' value='<%= s3credentials.encodedPolicy %>' />
						<input type='hidden' name='signature' value='<%= s3credentials.encodedSignature %>' />
						<input type='hidden' name='key' />

						<div class="form-group">
						    <label for="file">Arquivo:</label>
						    <input type='file' name='file' />
						</div>
					</form>

				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
				</div>
			</div>
		</div>
	</div>

</script>

<script>
	$('#components').append( $('#<%= field.name %>-s3popup-html').html() )
	$(document).ready(function(){
		$('#<%= field.name %>-s3popup input[name=file]').change(function(eventObject){

			function guid() {
				var S4 = function() { return (((1+Math.random())*0x10000)|0).toString(16).substring(1) }
				return S4()+S4()+"-"+S4()+"-"+S4()+"-"+S4()+"-"+S4()+S4()+S4()
			}

			var file = this.files[0]
			  , fileExt = file.type.split('/')[1]
			  , fileName = guid() + '.' + fileExt 
			  , fileURL = $('#<%= field.name %>-s3popup-form').attr('data-fileURL')+fileName

			$('#<%= field.name %>-s3popup-form input[name=key]').val('files/'+fileName)
			// $('#<%= field.name %>-s3popup-form input[name=Content-Type]').val(file.type)
			
			var form = document.getElementById('<%= field.name %>-s3popup-form')
			  , formData = new FormData(form)
			  , bucketURL = $('#<%= field.name %>-s3popup-form').attr('action')
			
			$.ajax({
				type: 'POST',
				url: bucketURL,
				data: formData,
				cache: false,
				context: { fileURL: fileURL },
				contentType: false,
				processData: false,
				success: function(){
					$('[name=<%= field.name %>]').val( this.fileURL )
					$.model.record.<%= field.name %> = this.fileURL
					$('#<%= field.name %>-s3popup').modal('hide')
				}
			})
		})
	})
</script>