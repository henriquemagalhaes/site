<input type='hidden' name='<%= field.name %>-id' data-field='<%= field.name %>' data-fieldset='<%= fieldset.name %>' />
<div class='input-group'>
	<input class='form-control autocomplete' type='text' name='<%= field.name %>-desc' data-field='<%= field.name %>' data-fieldset='<%= fieldset.name %>' onKeyUp='$.view.<%= field.name %>KeyUp(event)'/>
	<i class='input-group-addon glyphicon glyphicon-chevron-down clicable' onClick=''></i>
</div>

<div class='suggestions'>
	<ul id='<%= field.name %>-suggestions' class='list-group'></ul>
</div>

<script id='<%= field.name %>-suggestion-tpl' type="text/html">
	<li class='list-group-item suggestion clicable' onClick='$.view.<%= field.name %>AcceptSuggestion( "{{_id}}" )'>
		<span>{{desc}}</span>
	</li>
</script>

<script type="text/javascript">

	$.model.talkToServer( 'GET', '<%= baseURL %>/<%= field.of %>/list', function( records, txt, jqXHR ){ Locstor.set('<%= field.name %>', records) })

	$.view.<%= field.name %>AcceptSuggestion = function( _id ){
	
		var suggestion = $.view.<%= field.name %>CurrentResults.find({ _id: _id })
		  
		$('[name=<%= field.name %>-id]').val( suggestion._id )
		$('[name=<%= field.name %>-desc]').val( suggestion.desc )
		$('#<%= field.name %>-suggestions').html('')
		$.view.<%= field.name %>ActiveSuggestionIdx = undefined
		$.view.<%= field.name %>CurrentSearchVal = undefined
		$.view.<%= field.name %>CurrentResults = undefined
	}

	$.view.<%= field.name %>RefuseSuggestions = function(){
		$('#<%= field.name %>-suggestions').html('')
		$('[name=<%= field.name %>-desc]').val('')
		$.view.<%= field.name %>ActiveSuggestionIdx = undefined
		$.view.<%= field.name %>CurrentSearchVal = undefined
		$.view.<%= field.name %>CurrentResults = undefined
	}

	$.view.<%= field.name %>ActivateSuggestion = function( idx ){
		if ( $.view.<%= field.name %>CurrentResults[ idx ] ){
			$('#<%= field.name %>-suggestions li').removeClass('active')
			$( $('#<%= field.name %>-suggestions li')[idx] ).addClass('active')
			$.view.<%= field.name %>ActiveSuggestionIdx = idx
		}
	}

	$.view.<%= field.name %>GetSuggestions = function(){

		var searchVal = $('[name=<%= field.name %>-desc]').val()
		  , lastSearchVal = $.view.<%= field.name %>CurrentSearchVal

		if ( searchVal !== lastSearchVal ){
			
			var list = Locstor.get('<%= field.name %>')
			  , placeSelector = '#<%= field.name %>-suggestions'
			  , templateSelector = '#<%= field.name %>-suggestion-tpl'

			results = list.findAll({desc: new RegExp(searchVal, 'gi') })

			$( placeSelector ).html('')
			if (results){
				
				results.each(function( result ){
					$( templateSelector ).mu( result ).stache( placeSelector )
				})

				$.view.<%= field.name %>CurrentSearchVal = searchVal
				$.view.<%= field.name %>CurrentResults = results
				$.view.<%= field.name %>ActiveSuggestionIdx = 0
				$('#<%= field.name %>-suggestions li:first').addClass('active')
			}
		}
		
	}

	$.view.<%= field.name %>KeyUp = function(event){
		if ( 'Up'   === event.keyIdentifier ){
			if ( $.view.<%= field.name %>ActiveSuggestionIdx !== undefined ){
				$.view.<%= field.name %>ActivateSuggestion( $.view.<%= field.name %>ActiveSuggestionIdx - 1 )
			}
		}
		if ( 'Down'   === event.keyIdentifier ){
			if ( $.view.<%= field.name %>ActiveSuggestionIdx !== undefined ){
				$.view.<%= field.name %>ActivateSuggestion( $.view.<%= field.name %>ActiveSuggestionIdx + 1 )
			} else {
				$.view.<%= field.name %>GetSuggestions()
			}
		}
		if ( 'Enter'  === event.keyIdentifier ){
			if ( $.view.<%= field.name %>ActiveSuggestionIdx !== undefined ){
				$.view.<%= field.name %>AcceptSuggestion( $.view.<%= field.name %>ActiveSuggestionIdx )
			} else {
				$.view.<%= field.name %>GetSuggestions()
			}
		}
		if ( 'U+001B' === event.keyIdentifier ) {
			$.view.<%= field.name %>.RefuseSuggestions()
		}
	}

</script>